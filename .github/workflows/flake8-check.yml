name: Flake8 Static Analysis with Slack

on:
  schedule:
    - cron: '0 9 * * *'  # щодня о 09:00 UTC
  workflow_dispatch:

jobs:
  flake8-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8 per file with full report
        id: flake8
        run: |
          mkdir -p reports
          > reports/flake8_full_report.txt
          has_errors="false"

          for file in $(find app -type f -name "*.py"); do
            output=$(flake8 "$file")
            if [ -z "$output" ]; then
              echo "✅ $file — без помилок." >> reports/flake8_full_report.txt
            else
              has_errors="true"
              echo "❌ $file:" >> reports/flake8_full_report.txt
              echo "$output" >> reports/flake8_full_report.txt
              echo "" >> reports/flake8_full_report.txt
            fi
          done

          echo "has_errors=$has_errors" >> "$GITHUB_OUTPUT"

      - name: Upload full report
        uses: actions/upload-artifact@v3
        with:
          name: flake8-full-report
          path: reports/flake8_full_report.txt

      - name: Slack: found issues
        if: steps.flake8.outputs.has_errors == 'true'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_TITLE: "Flake8 ❌ Помилки в коді"
          SLACK_MESSAGE: "Знайдено проблеми. Перевір звіт: flake8_full_report.txt."

      - name: Slack: all clear
        if: steps.flake8.outputs.has_errors == 'false'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: good
          SLACK_TITLE: "Flake8 ✅ Код чистий"
          SLACK_MESSAGE: "Жодних проблем не виявлено. Усі файли без помилок."
